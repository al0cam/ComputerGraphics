<!DOCTYPE html>
<html lang="hr">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <title>WebGL2 - bojanje vrhova</title>
  <script src="RG-WebGL.js"></script>
  <script src="MT3D.js"></script>


  <script id="vertex-shader" type="x-shader/x-vertex">
    #version 300 es
    in vec3 a_vrhXY;
    in vec3 a_boja;
    uniform mat4 u_mTrans;

    out vec3 v_boja;

    void main() {
      gl_Position = vec4(u_mTrans*vec4(a_vrhXY,1.0));
      v_boja = a_boja;
    }
  </script>

  <script id="fragment-shader" type="x-shader/x-fragment">
    #version 300 es
    precision highp float;
    in vec3 v_boja;
    out vec4 bojaPiksela;

    void main() {
      bojaPiksela = vec4(v_boja, 1);
    }
  </script>

  <script>
    let gl;
    let GPUprogram1;
    let platno1;
    let mt3d;
    let korak = 0;
    let a;
    let xMax =  yMax = 1, zMax = 1;
    let xMin = yMin = -1, zMin = -1;
    window.addEventListener('load', (event) => {
      platno1 = document.getElementById("slika1");
      gl = platno1.getContext("webgl2");
      if (!gl) alert("WebGL2 nije dostupan!");

      GPUprogram1 = pripremiGPUprogram(gl, "vertex-shader", "fragment-shader");
      gl.useProgram(GPUprogram1); 

      GPUprogram1.u_mTrans = gl.getUniformLocation(GPUprogram1, "u_mTrans");
      // gl.enable(gl.DEPTH_TEST);
      gl.enable(gl.CULL_FACE);
      gl.enable(gl.BACK);

      mt3d = new MT3D();

      a = 0.5;
   
      crtajKocku();
      crtajPod();
    });

    function napuniSpremnike(vrhovi) {
        // povezivanje s atribut varijablama u programu za sjenčanje
      GPUprogram1.a_vrhXY = gl.getAttribLocation(GPUprogram1, "a_vrhXY");
      GPUprogram1.a_boja = gl.getAttribLocation(GPUprogram1, "a_boja");
      
      VAO = gl.createVertexArray();
      gl.bindVertexArray(VAO);
      gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
      gl.enableVertexAttribArray(GPUprogram1.a_vrhXY);
      gl.enableVertexAttribArray(GPUprogram1.a_boja);
      gl.vertexAttribPointer(GPUprogram1.a_vrhXY, 3, gl.FLOAT, false, 24, 0);
      gl.vertexAttribPointer(GPUprogram1.a_boja, 3, gl.FLOAT, false, 24, 12);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vrhovi.flat()), gl.STATIC_DRAW);
      return VAO;
    } 

    function iscrtaj(VAO, vrhovi, vrstaCrte) {
      gl.clearColor(0.5, 0.5, 0.5, 1);
      gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
      gl.viewport(0, 0, platno1.width, platno1.height);

      console.log(mt3d.lista());
      gl.uniformMatrix4fv(GPUprogram1.u_mTrans, false, mt3d.lista())

      gl.bindVertexArray(VAO);
      gl.drawArrays(vrstaCrte, 0, vrhovi.length);
    } 

    function crtajKocku()
    {
      let vrhovi = kocka()
      let kockaVAO = napuniSpremnike(vrhovi);
      mt3d.identitet()
      mt3d.ortho(xMin, xMax, yMin, yMax, zMin, zMax)
      iscrtaj(kockaVAO, vrhovi, gl.TRIANGLES)
    }

    function crtajPod()
    {
      let vrhovi = tile()
      let tileVAO = napuniSpremnike(vrhovi);
      floor(tileVAO, vrhovi)
    }

    function floor(tileVAO, vrhovi)
			{
				for(let i = xMin; i < xMax;i++)
				{
					for(let k = yMin; k < yMax;k++)
					{
						mt3d.identitet()
						mt3d.pomakni(i,k,0)
						mt3d.ortho(xMin, xMax, yMin, yMax, zMin, zMax)
            iscrtaj(tileVAO, vrhovi, gl.LINE)
					}
				}
			}

    function tile()
    {
      return [
        [-a,0,a, 0,1,0],
        [a,0,a, 0,1,0],
        [a,0,-a, 0,1,0],
        [-a,0,-a, 0,1,0],
      ]
    }

    function tileY()
    {
      return [
        [-a,a,0, 0,1,0],
        [a,a,0, 0,1,0],
        [a,-a,0, 0,1,0],
        [-a,-a,0, 0,1,0],
      ]
    }

    function kocka()
    {
      return [
        // front
        [-a, a, -a,  0, 1, 0],
        [-a, -a, -a,  0, 1, 0],
        [a, -a, -a,  0, 1, 0],

        [a, -a, -a,  0, 1, 0],
        [a, a, -a,  0, 1, 0],
        [-a, a, -a,  0, 1, 0],
      
        // left
        [-a, a, -a,  1, 0, 0],
        [-a, a, a,  1, 0, 0],
        [-a, -a, a,  1, 0, 0],

        [-a, -a, a,  1, 0, 0],
        [-a, -a, -a,  1, 0, 0],
        [-a, a, -a,  1, 0, 0],

        // bot
        [-a, -a, -a,  0, 0, 0],
        [-a, -a, a,  0, 0, 0],
        [a, -a, a,  0, 0, 0],
        
        [a, -a, a,  0, 0, 0],
        [a, -a, -a,  0, 0, 0],
        [-a, -a, -a,  0, 0, 0],

        // right
        [a, -a, -a,  0, 0, 1],
        [a, -a, a,  0, 0, 1],
        [a, a, a,  0, 0, 1],

        [a, a, a,  0, 0, 1],
        [a, a, -a,  0, 0, 1],
        [a, -a, -a,  0, 0, 1],

        // back
        [a, -a, a,  1, 1, 1],
        [-a, -a, a,  1, 1, 1],
        [-a, a, a,  1, 1, 1],
        
        [-a, a, a,  1, 1, 1],
        [a, a, a,  1, 1, 1],
        [a, -a, a,  1, 1, 1],

        // top
        [a, a, a,  0, 1, 1],
        [-a, a, a,  0, 1, 1],
        [-a, a, -a,  0, 1, 1],

        [-a, a, -a,  0, 1, 1],
        [a, a, -a,  0, 1, 1],
        [a, a, a,  0, 1, 1],
      ];
    }
	</script>
	</head>
	<body>
		<h1>WebGL2 - bojanje vrhova</h1>
		<div>
			<canvas id="slika1" style="border:5px solid black" width="500" height="500">
				Vaš preglednik ne podržava HTML5 canvas.
      </canvas>
		</div>
</body>
</html>