<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

        <meta charset="utf-8">
        <title>dvije teksture</title>

        <script src="dvije_teksture_files/MT2D.js"></script>
        <script src="dvije_teksture_files/RG-WebGL.js"></script>

        <style>
          li { 
            margin-bottom: 3px;
            margin-top: 3px;
          }

        </style>

        <script language="JavaScript">

        window.onload = WEBGLapp;

        async function loadImage(url) {
          const slika = new Image();
          slika.src = url;
          try {
            await slika.decode();
          } catch(err) {
            console.log('Greska:',err);
          }
          return slika;
        } 

        async function WEBGLapp() {
            urls = ['pozega.png', 'pozega2.png'];
            var slike = await Promise.all(urls.map(loadImage));

            var not_OK = slike.map(x => x.width).some(element => element === 0);            
            if (not_OK) {
              alert('Nema nekih tekstura!');
              return;
            }

            var kan = document.getElementById("kan");

            //definiranje geometrije preko javascript polja
            var vrhovi = [0,slike[0].height, slike[0].width,slike[0].height, 0,0, slike[0].width,0,
                          0,slike[1].height, slike[1].width,slike[1].height, 0,0, slike[1].width,0];
            var tex = [0,0, 1,0, 0,1, 1,1,
                       0,0, 1,0, 0,1, 1,1];

            //bufferi
            var vrhoviBuffer, texBuffer;

            //vertex array object
            var vao;

            var mat = new MT2D();

            var gl = null, program1 = null;
            var tekstura = []; //za kreiranje teksture

            var kan_width, kan_height; //dimenzije canvasa

            function initBuffers() {
              vrhoviBuffer = gl.createBuffer();
              texBuffer = gl.createBuffer();
              vao = gl.createVertexArray();

              tekstura[0] = gl.createTexture();
              gl.bindTexture(gl.TEXTURE_2D, tekstura[0]);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
              gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, slike[0]);
              gl.bindTexture(gl.TEXTURE_2D, null);

              tekstura[1] = gl.createTexture();
              gl.bindTexture(gl.TEXTURE_2D, tekstura[1]);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
              gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, slike[1]);
              gl.bindTexture(gl.TEXTURE_2D, null);

              gl.bindVertexArray(vao);
              gl.enableVertexAttribArray(0);
              gl.enableVertexAttribArray(1);

              gl.bindBuffer(gl.ARRAY_BUFFER, vrhoviBuffer);
              gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);
              gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vrhovi), gl.STATIC_DRAW);
              gl.bindBuffer(gl.ARRAY_BUFFER, null);
              
              gl.bindBuffer(gl.ARRAY_BUFFER, texBuffer);
              gl.vertexAttribPointer(1, 2, gl.FLOAT, false, 0, 0);
              gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(tex), gl.STATIC_DRAW);
              gl.bindBuffer(gl.ARRAY_BUFFER, null);

              gl.bindVertexArray(null);
            }

          function drawScene() {
              gl.clearColor(0.5, 0.5, 0.5, 1);
              gl.clear(gl.COLOR_BUFFER_BIT);

              gl.bindVertexArray(vao);

              mat.identitet();
              mat.projekcija2D(0,kan_width/2,0,kan_height);
              gl.uniformMatrix3fv(program.u_pmatrica, false, mat.poljeMatrica());

              gl.activeTexture(gl.TEXTURE0);
              gl.uniform1i(program.u_slika, 0);
              gl.bindTexture(gl.TEXTURE_2D, tekstura[0]);

              gl.viewport(10, 10, kan_width/2, kan_height);
              gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

              gl.activeTexture(gl.TEXTURE1);
              gl.uniform1i(program.u_slika, 1);
              gl.bindTexture(gl.TEXTURE_2D, tekstura[1]);

              gl.viewport(kan_width/2, 10, kan_width/2, kan_height);
              gl.drawArrays(gl.TRIANGLE_STRIP, 4, 4);
            }

            function WebGL_aplikacija() {
              gl = kan.getContext("webgl2");
              if (!gl) alert("WEBGL2 nije dostupan!");
              program = pripremiGPUprogram(gl, "vertex-shader", "fragment-shader");
              gl.useProgram(program);
              program.u_pmatrica = gl.getUniformLocation(program, "u_pmatrica");
              program.u_slika = gl.getUniformLocation(program, "u_slika");

              kan_width = kan.width;
              kan_height = kan.height;

              //da crta teksturu od gore prema dolje
              //gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);

              initBuffers();
              drawScene();
            }

            WebGL_aplikacija();

        }
        </script>

        <script id="vertex-shader" type="x-shader/x-vertex">
            #version 300 es
            layout(location = 0) in vec2 a_position;
            layout(location = 1) in vec2 a_tekstura;

            uniform mat3 u_pmatrica;
            out vec2 v_tekstura;

            void main() {
              vec3 vek = u_pmatrica * vec3(a_position,1);
              gl_Position = vec4(vek.xy, 0, 1);
              v_tekstura = a_tekstura;
            }
        </script>

        <script id="fragment-shader" type="x-shader/x-fragment">
            #version 300 es
            precision mediump float;

            uniform sampler2D u_slika;
            in vec2 v_tekstura;
            out vec4 outColor;

            void main() {
              outColor = texture(u_slika, v_tekstura);
            }
        </script>

    </head>

    <body>
      <div id="naslov"> <h1>WebGL2 - Učitavanje više tekstura</h1> </div>
      <canvas id="kan" tabindex="0" style="border:5px solid black" width="1050" height="400">
          Your browser does not support HTML5 canvas.
      </canvas>
      <ul>
        <li>Primjer pokazuje kako učitati više tekstura, u ovom slučaju dvije teksture.</li>
      </ul>
    


</body></html>